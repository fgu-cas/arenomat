<!DOCTYPE html>
<!--  
 (c) 2013 info@michalvondracek.cz
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Arenomat</title>
<link rel="stylesheet" href="css/bootstrap.min.css">

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="js/blockly_compressed.js"></script>
        <script type="text/javascript" src="js/javascript_compressed.js"></script>
        <script type="text/javascript" src="js/en_compressed.js"></script>
        <script type="text/javascript" src="js/storage.js"></script>

        <script src="/socket.io/socket.io.js"></script>

        <script type="text/javascript" src="js/storage.js"></script>

        <script type="text/javascript" src="blocks/input.js"></script>
        <script type="text/javascript" src="blocks/output.js"></script>
        <script type="text/javascript" src="blocks/messages.js"></script>

    <script language="javascript" src="js/jquery.canvasAreaDraw.js"></script>

<style>
@import url(//fonts.googleapis.com/css?family=Leckerli+One);
.navbar-brand {
    font-family: 'Leckerli One';
    font-size: 35px;
    font-style: normal;
    font-weight: 700;
    color: #428bca !important;
    text-shadow: 1px 1px #fff !important;
    &:hover {
        color: #51CA42 !important;
    }
}

canvas {
    z-index: 999;
    position: absolute;
    display: block;
}

.area {
    z-index: -1;
}
</style>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Arenomat</a>
    </div>
       <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
             <li class="active"><a href="#" id="elapsedTime">.</a></li>
            </ul>
          </div><!--/.nav-collapse -->
</div>
</nav>
    <div class="container-fluid">
		<ul class="nav nav-tabs">
			<li class="active"><a data-toggle="tab" href="#logic">Logic</a></li>
			<li><a data-toggle="tab" href="#camera">Camera</a></li>
			<li><a data-toggle="tab" href="#settings">Settings</a></li>
		</ul>

		<div class="tab-content">
			<div id="logic" class="tab-pane fade in active">
			    <div class="row">
			    <div class="col-md-12">
				<div id="blockly" style="height: 500px; width: 100%"></div>
			    </div>
		</div>
			    <div class="row">
			    <div class="col-md-12">
				<a id="codeStart" class="btn btn-primary" href="#">START</a>
				<a id="codeStop" class="btn btn-danger" href="#">STOP</a>
			    </div>
			    </div>
			</div>

			<div id="camera" class="tab-pane fade">
			    <div class="row">
			    <span class="col-md-4">
				<img width=500 height=375 id="cam" class="area" style="float: left" />
				<br /><span id="cam_counter">0</span>
			    </span>
			    <span class="col-md-4">
				<img width=500 height=375 id="cv" style="float: right" />
				<br /><span id="cv_counter">0</span>
			    </span>
			    <span class="col-md-4">
				<canvas id="myCanvas" width="500" height="375" style="background-color: #fdffdd">
				</canvas>
			    </span>
			    </div>
			</div>

			<div id="replay" class="tab-pane fade">
				replay
			</div>
			<div id="settings" class="tab-pane fade">
				settings
			</div>
		</div>
	</div>






<xml id="toolbox" style="display: none">
	<category name="Control">
		<category name="If">
			<block type="controls_if"></block>
			<block type="controls_if">
				<mutation else="1"></mutation>
			</block>
			<block type="controls_if">
				<mutation elseif="1" else="1"></mutation>
			</block>
		</category>
		<category name="Loops">
			<block type="controls_repeat_ext">
				<value name="TIMES">
					<block type="math_number">
						<title name="NUM">10</title>
					</block>
				</value>
			</block>
			<block type="controls_whileUntil"></block>
			<block type="controls_for">
				<title name="VAR">i</title>
				<value name="FROM">
					<block type="math_number">
						<title name="NUM">1</title>
					</block>
				</value>
				<value name="TO">
					<block type="math_number">
						<title name="NUM">10</title>
					</block>
				</value>
				<value name="BY">
					<block type="math_number">
						<title name="NUM">1</title>
					</block>
				</value>
			</block>
			<block type="controls_forEach"></block>
			<block type="controls_flow_statements"></block>
		</category>
	</category>
	<category name="Input">
		<block type="motor_position"></block>
		<block type="area"></block>
		<block type="time"></block>
	</category>
	<category name="Output">
		<block type="light"></block>
		<block type="shock"></block>
		<block type="turntable"></block>
		<block type="feeder"></block>
		<block type="sound"></block>
	</category>
	<category name="Logic">
		<block type="logic_compare"></block>
		<block type="logic_operation"></block>
		<block type="logic_negate"></block>
		<block type="logic_boolean"></block>
		<block type="logic_null"></block>
		<block type="logic_ternary"></block>
	</category>
	<category name="Math">
		<block type="math_number"></block>
		<block type="math_arithmetic"></block>
		<block type="math_single"></block>
		<block type="math_trig"></block>
		<block type="math_constant"></block>
		<block type="math_number_property"></block>
		<block type="math_change">
			<value name="DELTA">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
		</block>
		<block type="math_round"></block>
		<block type="math_on_list"></block>
		<block type="math_modulo"></block>
		<block type="math_constrain">
			<value name="LOW">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
			<value name="HIGH">
				<block type="math_number">
					<title name="NUM">100</title>
				</block>
			</value>
		</block>
		<block type="math_random_int">
			<value name="FROM">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
			<value name="TO">
				<block type="math_number">
					<title name="NUM">100</title>
				</block>
			</value>
		</block>
		<block type="math_random_float"></block>
	</category>
	<category name="Lists">
		<block type="lists_create_empty"></block>
		<block type="lists_create_with"></block>
		<block type="lists_repeat">
			<value name="NUM">
				<block type="math_number">
					<title name="NUM">5</title>
				</block>
			</value>
		</block>
		<block type="lists_length"></block>
		<block type="lists_isEmpty"></block>
		<block type="lists_indexOf"></block>
		<block type="lists_getIndex"></block>
		<block type="lists_setIndex"></block>
	</category>
	<category name="Text">
		<block type="text"></block>
		<block type="text_length"></block>
    </category>
	<category name="Messages">
		<block type="message"></block>
    </category>
	<category name="Variables" custom="VARIABLE"></category>
	<category name="Functions" custom="PROCEDURE"></category>
	<category name="Library">
		<category name="Randomize">
			<block type="procedures_defnoreturn">
				<mutation>
					<arg name="list"></arg>
				</mutation>
				<title name="NAME">randomize</title>
				<statement name="STACK">
					<block type="controls_for" inline="true">
						<title name="VAR">x</title>
						<value name="FROM">
							<block type="math_number">
								<title name="NUM">1</title>
							</block>
						</value>
						<value name="TO">
							<block type="lists_length" inline="false">
								<value name="VALUE">
									<block type="variables_get">
										<title name="VAR">list</title>
									</block>
								</value>
							</block>
						</value>
						<value name="BY">
							<block type="math_number">
								<title name="NUM">1</title>
							</block>
						</value>
						<statement name="DO">
							<block type="variables_set" inline="false">
								<title name="VAR">y</title>
								<value name="VALUE">
									<block type="math_random_int" inline="true">
										<value name="FROM">
											<block type="math_number">
												<title name="NUM">1</title>
											</block>
										</value>
										<value name="TO">
											<block type="lists_length" inline="false">
												<value name="VALUE">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
											</block>
										</value>
									</block>
								</value>
								<next>
									<block type="variables_set" inline="false">
										<title name="VAR">temp</title>
										<value name="VALUE">
											<block type="lists_getIndex" inline="true">
												<mutation statement="false" at="true"></mutation>
												<title name="MODE">GET</title>
												<title name="WHERE">FROM_START</title>
												<value name="AT">
													<block type="variables_get">
														<title name="VAR">y</title>
													</block>
												</value>
												<value name="VALUE">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
											</block>
										</value>
										<next>
											<block type="lists_setIndex" inline="false">
												<value name="AT">
													<block type="variables_get">
														<title name="VAR">y</title>
													</block>
												</value>
												<value name="LIST">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
												<value name="TO">
													<block type="lists_getIndex" inline="true">
														<mutation statement="false" at="true"></mutation>
														<title name="MODE">GET</title>
														<title name="WHERE">FROM_START</title>
														<value name="AT">
															<block type="variables_get">
																<title name="VAR">x</title>
															</block>
														</value>
														<value name="VALUE">
															<block type="variables_get">
																<title name="VAR">list</title>
															</block>
														</value>
													</block>
												</value>
												<next>
													<block type="lists_setIndex" inline="false">
														<value name="AT">
															<block type="variables_get">
																<title name="VAR">x</title>
															</block>
														</value>
														<value name="LIST">
															<block type="variables_get">
																<title name="VAR">list</title>
															</block>
														</value>
														<value name="TO">
															<block type="variables_get">
																<title name="VAR">temp</title>
															</block>
														</value>
													</block>
												</next>
											</block>
										</next>
									</block>
								</next>
							</block>
						</statement>
					</block>
				</statement>
			</block>
		</category>
	</category>
</xml>


<script type="text/javascript">
	// TODO: dynamically!
	var socket = io.connect('http://192.168.0.103');

	Blockly.inject(document.getElementById('blockly'),
			{path: './', toolbox: document.getElementById('toolbox')});

	/**
	 * Bind an event to a function call.
	 * @param {!Element} element Element upon which to listen.
	 * @param {string} name Event name to listen to (e.g. 'mousedown').
	 * @param {!Function} func Function to call when event is triggered.
	 *     W3 browsers will call the function with the event object as a parameter,
	 *     MSIE will not.
	 */
	function bindEvent(element, name, func) {
		if (element.addEventListener) {  // W3C
			element.addEventListener(name, func, false);
		} else if (element.attachEvent) {  // IE
			element.attachEvent('on' + name, func);
		}
	}


	/**
	 * Backup code blocks to localStorage.
	 */
	function backup_blocks() {
		console.log('backup');
		if ('localStorage' in window) {
			var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
			window.localStorage.setItem('arenomat', Blockly.Xml.domToText(xml));
		}
	}

	/**
	 * Restore code blocks from localStorage.
	 */
	function restore_blocks() {
		if ('localStorage' in window && window.localStorage.arenomat) {
			var xml = Blockly.Xml.textToDom(window.localStorage.arenomat);
			Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
		}
	}

	function auto_save_and_restore_blocks() {
		// Restore saved blocks in a separate thread so that subsequent
		// initialization is not affected from a failed load.
		window.setTimeout(restore_blocks, 0);
		// Hook a save function onto unload.
		bindEvent(window, 'unload', backup_blocks);
	}

	auto_save_and_restore_blocks();

	var old;
	var cam_counter = 0;
	var cv_counter = 0;

	$("#codeStart").click(function() {
	    var code = Blockly.Generator.workspaceToCode('JavaScript');
	    socket.emit('codeStart', code);
	});

	$("#codeStop, #elapsedTime").click(function() {
	    socket.emit('codeStop');
	});

	socket.on('position', function(position) {
		if (position && position.x && position.y) {

			if (!old)
				old = position;

			var c = document.getElementById("myCanvas");
			var ctx = c.getContext("2d");
			ctx.clearRect(old.x, old.y, 10, 10);
			ctx.beginPath();
			ctx.rect(position.x, position.y, 10, 10);
			ctx.fillStyle = 'rgba(46, 166, 203, 0.5)';
			ctx.fill();
			ctx.beginPath();
			ctx.moveTo(old.x, old.y);
			ctx.globalAlpha = 0.5;
			ctx.lineTo(position.x, position.y);
			ctx.strokeStyle = '#2ba6cb';
			ctx.stroke();

			old = position;
		}
	});


	var oldtime = 0;
	socket.on('webcam', function(base64Image) {
		var now = Date.now();
		$('#cam_counter').text('' + (cam_counter++) + ' fps: ' + (1000/(now - oldtime)).toFixed(2));
		$('#cam').attr('src', base64Image);
		oldtime = now;
	});
	socket.on('cv', function(base64Image) {
		$('#cv_counter').text(cv_counter++);
		$('#cv').attr('src', base64Image);
	});
	socket.on('elapsedTime', function(elapsedTime) {
		$('#elapsedTime').text(elapsedTime.toFixed(2));
	});

    // store the currently selected tab in the hash value
    $("ul.nav-tabs > li > a").on("shown.bs.tab", function (e) {
        var id = $(e.target).attr("href").substr(1);
        window.location.hash = id;
    });
</script>
</body>
</html>