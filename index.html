<!DOCTYPE html>
<!--  
 (c) 2013 info@michalvondracek.cz
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Arenomat</title>
<link rel="stylesheet" href="css/bootstrap.min.css">

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="js/blockly_compressed.js"></script>
        <script type="text/javascript" src="js/javascript_compressed.js"></script>
        <script type="text/javascript" src="js/en_compressed.js"></script>
        <script type="text/javascript" src="js/storage.js"></script>

        <script type="text/javascript" src="/socket.io/socket.io.js"></script>

        <script type="text/javascript" src="js/storage.js"></script>

        <script type="text/javascript" src="blocks/input.js"></script>
        <script type="text/javascript" src="blocks/output.js"></script>

    <script type="text/javascript" src="js/BlobBuilder.min.js"></script>
    <script type="text/javascript" src="js/FileSaver.min.js"></script>
    <script type="text/javascript" src="js/jquery.canvasAreaDraw.js"></script>

<style>
@import url(//fonts.googleapis.com/css?family=Leckerli+One);
.navbar-brand {
    font-family: 'Leckerli One';
    font-size: 35px;
    font-style: normal;
    font-weight: 700;
    color: #428bca !important;
    text-shadow: 1px 1px #fff !important;
    &:hover {
        color: #51CA42 !important;
    }
}
.navbar-nav {
    border-bottom: none !important;
}


.navbar-default .navbar-nav>.active>a, .navbar-default .navbar-nav>.active>a:hover, .navbar-default .navbar-nav>.active>a:focus {
    background: white !important;
    color: black !important;
}

canvas {
    display: block;
}
</style>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Ar√©nOmat</a>
    </div>
       <div class="navbar-collapse collapse">
		<ul class="nav navbar-nav nav-tabs">
			<li class="active"><a data-toggle="tab" href="#tlogic">Logic</a></li>
			<li><a data-toggle="tab" href="#tcamera">Camera</a></li>
			<li><a data-toggle="tab" href="#tsettings">Settings</a></li>
			<li>
		</ul>


            <ul class="nav navbar-nav navbar-right">
	    <li class="active"><a href="#"  id="shocking">.......</a></li>
             <li class="active"><a href="#" id="elapsedTime">.</a></li>

            </ul>
          </div><!--/.nav-collapse -->
</div>
</nav>
    <div class="container-fluid">

		<div class="tab-content">
			<div id="tlogic" class="tab-pane fade in active">
			    <div class="row">
			    <div class="col-md-12">
				<div id="blockly" style="height: 500px; width: 100%"></div>
			    </div>
		</div>
			    <div class="row">
<br />
			    <div class="col-md-12">
<div class="btn-toolbar" role="toolbar">
<div class="btn-group">
				<a id="codeStart" class="btn btn-success" href="#">START</a>
				<a id="codeStop" class="btn btn-danger" href="#">STOP</a>
</div>

<div class="btn-group">
				<a id="codeSave" class="btn btn-warning" href="#">save</a>
				<a id="codeLoad" class="btn btn-primary" href="#">load</a>
				<a id="codeClear" class="btn btn-danger" href="#">clear</a>
<input type="file" id="load" style="display: none;"/>
</div>
</div>
			    </div>
			    </div>
			</div>

			<div id="tcamera" class="tab-pane fade">
			    <div class="row">
			    <span class="col-md-6">
				<img width="640" height="480" id="cam" class="area" style="position: absolute" />
				<canvas id="areas"  width="640" height="480" style="position: absolute; border: 1px solid black; z-index: 999"></canvas>
				<canvas id="object" width="640" height="480" style="position: absolute; z-index: 900"></canvas>
				<canvas id="arena"  width="640" height="480" style="position: absolute"></canvas>
 <div class="progress progress-striped active">
    <div class="progress-bar"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
</div>
frames: <span id="cam_counter">0</span><br />
recognized: <span id="cv_counter">0</span><br />
fps: <span id="fps">0</span>
			    </span>
			    <span class="col-md-6">
			    </span>
			    </div>
			</div>

			<div id="treplay" class="tab-pane fade">
				replay
			</div>
			<div id="tsettings" class="tab-pane fade">
<br />
<form class="form-horizontal" role="form">
  <div class="form-group">
    <label for="dev" class="col-sm-2 control-label">Video device</label>
    <div class="col-sm-10">
      <input type="number" class="form-control" id="dev" placeholder="0">
    </div>
  </div>

  <div class="form-group">
    <label for="width" class="col-sm-2 control-label">Width</label>
    <div class="col-sm-10">
      <input type="number" class="form-control" id="width" placeholder="640">
    </div>
  </div>
  <div class="form-group">
    <label for="height" class="col-sm-2 control-label">Height</label>
    <div class="col-sm-10">
      <input type="number" class="form-control" id="height" placeholder="480">
    </div>
  </div>




  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <button type="submit" class="btn btn-default">Save</button>
    </div>
  </div>
</form>

			</div>
		</div>


	</div>

<div class="footer navbar-default navbar-fixed-bottom">
  <div class="container-fluid">
       <a class="active" href="#">Michal Vondracek (info@michalvondracek.cz)</a>
  </div>
</div>





<xml id="toolbox" style="display: none">
	<category name="Control">
		<category name="If">
			<block type="controls_if"></block>
			<block type="controls_if">
				<mutation else="1"></mutation>
			</block>
			<block type="controls_if">
				<mutation elseif="1" else="1"></mutation>
			</block>
		</category>
		<category name="Loops">
			<block type="controls_repeat_ext">
				<value name="TIMES">
					<block type="math_number">
						<title name="NUM">10</title>
					</block>
				</value>
			</block>
			<block type="controls_whileUntil"></block>
			<block type="controls_for">
				<title name="VAR">i</title>
				<value name="FROM">
					<block type="math_number">
						<title name="NUM">1</title>
					</block>
				</value>
				<value name="TO">
					<block type="math_number">
						<title name="NUM">10</title>
					</block>
				</value>
				<value name="BY">
					<block type="math_number">
						<title name="NUM">1</title>
					</block>
				</value>
			</block>
			<block type="controls_forEach"></block>
			<block type="controls_flow_statements"></block>
		</category>
	</category>
	<category name="Input">
		<block type="motor_position"></block>
		<block type="area"></block>
		<block type="time"></block>
	</category>
	<category name="Output">
		<block type="light"></block>
		<block type="shock"></block>
		<block type="turntable"></block>
		<block type="feeder"></block>
		<block type="sound"></block>
	</category>
	<category name="Logic">
		<block type="logic_compare"></block>
		<block type="logic_operation"></block>
		<block type="logic_negate"></block>
		<block type="logic_boolean"></block>
		<block type="logic_null"></block>
		<block type="logic_ternary"></block>
	</category>
	<category name="Math">
		<block type="math_number"></block>
		<block type="math_arithmetic"></block>
		<block type="math_single"></block>
		<block type="math_trig"></block>
		<block type="math_constant"></block>
		<block type="math_number_property"></block>
		<block type="math_change">
			<value name="DELTA">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
		</block>
		<block type="math_round"></block>
		<block type="math_on_list"></block>
		<block type="math_modulo"></block>
		<block type="math_constrain">
			<value name="LOW">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
			<value name="HIGH">
				<block type="math_number">
					<title name="NUM">100</title>
				</block>
			</value>
		</block>
		<block type="math_random_int">
			<value name="FROM">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
			<value name="TO">
				<block type="math_number">
					<title name="NUM">100</title>
				</block>
			</value>
		</block>
		<block type="math_random_float"></block>
	</category>
	<category name="Lists">
		<block type="lists_create_empty"></block>
		<block type="lists_create_with"></block>
		<block type="lists_repeat">
			<value name="NUM">
				<block type="math_number">
					<title name="NUM">5</title>
				</block>
			</value>
		</block>
		<block type="lists_length"></block>
		<block type="lists_isEmpty"></block>
		<block type="lists_indexOf"></block>
		<block type="lists_getIndex"></block>
		<block type="lists_setIndex"></block>
	</category>
	<category name="Text">
		<block type="text"></block>
		<block type="text_length"></block>
    </category>
	<category name="Messages">
		<block type="message"></block>
    </category>
	<category name="Variables" custom="VARIABLE"></category>
	<category name="Functions" custom="PROCEDURE"></category>
	<category name="Library">
		<category name="Randomize">
			<block type="procedures_defnoreturn">
				<mutation>
					<arg name="list"></arg>
				</mutation>
				<title name="NAME">randomize</title>
				<statement name="STACK">
					<block type="controls_for" inline="true">
						<title name="VAR">x</title>
						<value name="FROM">
							<block type="math_number">
								<title name="NUM">1</title>
							</block>
						</value>
						<value name="TO">
							<block type="lists_length" inline="false">
								<value name="VALUE">
									<block type="variables_get">
										<title name="VAR">list</title>
									</block>
								</value>
							</block>
						</value>
						<value name="BY">
							<block type="math_number">
								<title name="NUM">1</title>
							</block>
						</value>
						<statement name="DO">
							<block type="variables_set" inline="false">
								<title name="VAR">y</title>
								<value name="VALUE">
									<block type="math_random_int" inline="true">
										<value name="FROM">
											<block type="math_number">
												<title name="NUM">1</title>
											</block>
										</value>
										<value name="TO">
											<block type="lists_length" inline="false">
												<value name="VALUE">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
											</block>
										</value>
									</block>
								</value>
								<next>
									<block type="variables_set" inline="false">
										<title name="VAR">temp</title>
										<value name="VALUE">
											<block type="lists_getIndex" inline="true">
												<mutation statement="false" at="true"></mutation>
												<title name="MODE">GET</title>
												<title name="WHERE">FROM_START</title>
												<value name="AT">
													<block type="variables_get">
														<title name="VAR">y</title>
													</block>
												</value>
												<value name="VALUE">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
											</block>
										</value>
										<next>
											<block type="lists_setIndex" inline="false">
												<value name="AT">
													<block type="variables_get">
														<title name="VAR">y</title>
													</block>
												</value>
												<value name="LIST">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
												<value name="TO">
													<block type="lists_getIndex" inline="true">
														<mutation statement="false" at="true"></mutation>
														<title name="MODE">GET</title>
														<title name="WHERE">FROM_START</title>
														<value name="AT">
															<block type="variables_get">
																<title name="VAR">x</title>
															</block>
														</value>
														<value name="VALUE">
															<block type="variables_get">
																<title name="VAR">list</title>
															</block>
														</value>
													</block>
												</value>
												<next>
													<block type="lists_setIndex" inline="false">
														<value name="AT">
															<block type="variables_get">
																<title name="VAR">x</title>
															</block>
														</value>
														<value name="LIST">
															<block type="variables_get">
																<title name="VAR">list</title>
															</block>
														</value>
														<value name="TO">
															<block type="variables_get">
																<title name="VAR">temp</title>
															</block>
														</value>
													</block>
												</next>
											</block>
										</next>
									</block>
								</next>
							</block>
						</statement>
					</block>
				</statement>
			</block>
		</category>
	</category>
</xml>


<script type="text/javascript">
	// TODO: dynamically!
	var socket = io.connect('http://192.168.0.103');

	Blockly.inject(document.getElementById('blockly'),
			{path: './', toolbox: document.getElementById('toolbox')});

	/**
	 * Bind an event to a function call.
	 * @param {!Element} element Element upon which to listen.
	 * @param {string} name Event name to listen to (e.g. 'mousedown').
	 * @param {!Function} func Function to call when event is triggered.
	 *     W3 browsers will call the function with the event object as a parameter,
	 *     MSIE will not.
	 */
	function bindEvent(element, name, func) {
		if (element.addEventListener) {  // W3C
			element.addEventListener(name, func, false);
		} else if (element.attachEvent) {  // IE
			element.attachEvent('on' + name, func);
		}
	}


	/**
	 * Backup code blocks to localStorage.
	 */
	function backup_blocks() {
		console.log('backup');
		if ('localStorage' in window) {
			var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
			window.localStorage.setItem('arenomat', Blockly.Xml.domToText(xml));
		}
	}

	/**
	 * Restore code blocks from localStorage.
	 */
	function restore_blocks() {
		if ('localStorage' in window && window.localStorage.arenomat) {
			var xml = Blockly.Xml.textToDom(window.localStorage.arenomat);
			Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
		}
	}

	function auto_save_and_restore_blocks() {
		// Restore saved blocks in a separate thread so that subsequent
		// initialization is not affected from a failed load.
		window.setTimeout(restore_blocks, 0);
		// Hook a save function onto unload.
		bindEvent(window, 'unload', backup_blocks);
	}



/**
* Save blocks to local file
*/
function save() {
  var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
  var data = Blockly.Xml.domToText(xml);

  // Store data in blob.
  var builder = new BlobBuilder;
  builder.append(data);
  saveAs(builder.getBlob("text/plain;charset=utf-8"), "block.xml");
};

/**
* Load blocks from local file
*
*/
function load(event) {
    if (!event) return;

  var files = event.target.files;
  
  // Only allow uploading one file.
  if (files.length !== 1)
    return;

  // FileReader
  var reader = new FileReader();
  reader.onloadend = function(event) {
    var target = event.target;
    // 2 === FileReader.DONE
    if (target.readyState === 2) {
      if (confirm("Want to clean current blocks? Press 'Cancel' will load blocks into current workspace.")) { 
        Blockly.mainWorkspace.clear();
      }
      var xml = Blockly.Xml.textToDom(target.result);
      Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
    }
    // Reset value of input after loading
    // because Chrome will not fire a 'change' event
    // if the same file is loaded again.
    loadInput.value = '';
  };
  reader.readAsText(files[0]);
};

function clear() {
  var count = Blockly.mainWorkspace.getAllBlocks().length;
  if ((count > 2) || window.confirm('Are you sure?')) {
    Blockly.mainWorkspace.clear();
  }
}


	auto_save_and_restore_blocks();

// arena image
	var c = document.getElementById("arena");
	var ctx = c.getContext("2d");
	ctx.arc(ctx.canvas.width/2, ctx.canvas.height/2, 5, 0, Math.PI*2);
	ctx.stroke();
	ctx.arc(ctx.canvas.width/2, ctx.canvas.height/2, ctx.canvas.height/2, 0, Math.PI*2);
	ctx.fillStyle = 'rgba(250, 250, 250, 0.3)';
	ctx.fill();



  // init load event
  var loadInput = document.getElementById('load');
  loadInput.addEventListener('change', load, false);
  document.getElementById('codeLoad').onclick = function() {
        loadInput.click();
  };


	var old, position = { x: 0, y: 0 };
	var cam_counter = 0;
	var cv_counter = 0;
	var activeArea = [ false ];

	$("#codeStart").click(function() {
	    var code = Blockly.Generator.workspaceToCode('JavaScript');
	    socket.emit('codeStart', code);
	});
	$("#codeSave").click(function() {
	    save();
	});

	$("#codeLoad").click(function() {
	    load();
	});
	$("#codeClear").click(function() {
	    clear();
	});

	$("#codeStop, #elapsedTime").click(function() {
	    socket.emit('codeStop');
	});

	var oldtime = 0;

	socket.on('shocking', function(shocking) {
	    $('#shocking').css('background',(shocking > 0) ? 'red !important' : 'black !important');
	    $('#shocking').text(shocking/10);
	});
	socket.on('activeArea', function(data) {
	    activeArea = data;
	});

	socket.on('webcam', function(base64Image) {
		var now = Date.now();
		$('#cam_counter').text(cam_counter);
var fps = (1000/(now - oldtime)).toFixed(0);
		$('#fps').text(fps);
 $('#fps').css('color', (fps < 15) ? 'red' : 'green');

		$('#cv_counter').text(cv_counter);

    var perc = (cv_counter / cam_counter * 100).toFixed(1);
$('.progress-bar').css('width', perc+'%').text(perc);

		$('#cam').attr('src', base64Image);
		oldtime = now;
		cam_counter++;
	});
	socket.on('position', function(pos) {
		position = pos;
		if (!position.x && !position.y && old) {
			var c = document.getElementById("object");
			var ctx = c.getContext("2d");
			ctx.arc(old[old.length - 1].x+5, old[old.length - 1].y+5, 10, 0, Math.PI*2, true);
			ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
			ctx.fill();
		}
		else {
			if (!old)
				old = [position];

			cv_counter++;

			if (old[old.length -1].x != position.x && old[old.length - 1].y != position.y) {

			var c = document.getElementById("object");
			var ctx = c.getContext("2d");
			ctx.canvas.width = ctx.canvas.width;
//			ctx.clearRect(old.x, old.y, 10, 10);
			ctx.arc(position.x+5, position.y+5, 10, 0, Math.PI*2, true);
			ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
			ctx.fill();


			ctx.beginPath();
			ctx.globalAlpha = 1;
			for(var i = 1; i < old.length; i++) {
			ctx.moveTo(old[i-1].x, old[i-1].y);
			    ctx.lineTo(old[i].x, old[i].y);
			}
			ctx.strokeStyle = '#2ba6cb';
			ctx.stroke();


			old.push(position);

			if (old.length > 200) old.shift();

    $('#area').canvasAreaDraw();

		    }
		}

	});
	socket.on('elapsedTime', function(elapsedTime) {
		$('#elapsedTime').text(elapsedTime.toFixed(2));
	});

  $(document).ready(function() {
    if(location.hash) {
       $('a[href=' + location.hash + ']').tab('show');
    }
  $(document.body).on("click", "a[data-toggle]", function(event) {
    location.hash = this.getAttribute("href");
  });
});
  $(window).on('popstate', function() {
    var anchor = location.hash || $("a[data-toggle=tab]").first().attr("href");
    $('a[href=' + anchor + ']').tab('show');
  });

    $('#area').canvasAreaDraw();
</script>
</body>
</html>