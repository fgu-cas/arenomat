<!DOCTYPE html>
<!--  
 (c) 2013 majklovec@seznam.cz
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome-ie7.css" rel="stylesheet">


	<script type="text/javascript" src="js/blockly_compressed.js"></script>
	<script type="text/javascript" src="js/javascript_compressed.js"></script>
	<script type="text/javascript" src="js/en_compressed.js"></script>
	<script type="text/javascript" src="js/storage.js"></script>

	<script src="/socket.io/socket.io.js"></script>

	<script type="text/javascript" src="blocks/input.js"></script>
	<script type="text/javascript" src="blocks/output.js"></script>
	<script type="text/javascript" src="blocks/messages.js"></script>

    <script language="javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
    <script language="javascript" src="js/jquery.canvasAreaDraw.min.js"></script>


</head>
<body>
    <div class="container">
		<h1>Space-time</h1>

		<ul class="nav nav-tabs">
			<li class="active"><a data-toggle="tab" href="#logic">Logic</a></li>
			<li><a data-toggle="tab" href="#camera">Camera</a></li>
			<li><a data-toggle="tab" href="#replay">Replay</a></li>
			<li><a data-toggle="tab" href="#settings">Settings</a></li>
		</ul>

		<div class="tab-content">
			<div id="logic" class="tab-pane fade in active">
				<div id="blockly" style="height: 95%; width: 95%"></div>
			</div>
			<div id="camera" class="tab-pane fade">
				<img width=500 id="cam" class="area" style="float: left" />
				<img width=500 id="cv" style="float: right" />

				<canvas id="myCanvas" width="500" height="500" style="border:1px solid #000000;">
				</canvas>
			</div>

			<div id="replay" class="tab-pane fade">
				replay
			</div>
			<div id="settings" class="tab-pane fade">
				settings
			</div>
		</div>
	</div>






<xml id="toolbox" style="display: none">
	<category name="Control">
		<category name="If">
			<block type="controls_if"></block>
			<block type="controls_if">
				<mutation else="1"></mutation>
			</block>
			<block type="controls_if">
				<mutation elseif="1" else="1"></mutation>
			</block>
		</category>
		<category name="Loops">
			<block type="controls_repeat_ext">
				<value name="TIMES">
					<block type="math_number">
						<title name="NUM">10</title>
					</block>
				</value>
			</block>
			<block type="controls_whileUntil"></block>
			<block type="controls_for">
				<title name="VAR">i</title>
				<value name="FROM">
					<block type="math_number">
						<title name="NUM">1</title>
					</block>
				</value>
				<value name="TO">
					<block type="math_number">
						<title name="NUM">10</title>
					</block>
				</value>
				<value name="BY">
					<block type="math_number">
						<title name="NUM">1</title>
					</block>
				</value>
			</block>
			<block type="controls_forEach"></block>
			<block type="controls_flow_statements"></block>
		</category>
	</category>
	<category name="Input">
		<block type="temperature"></block>
		<block type="humidity"></block>
		<block type="light"></block>
		<block type="range"></block>
	</category>
	<category name="Output">
		<block type="lamp"></block>
		<block type="fan"></block>
		<block type="humidifier"></block>
		<block type="sound"></block>
	</category>
	<category name="Logic">
		<block type="logic_compare"></block>
		<block type="logic_operation"></block>
		<block type="logic_negate"></block>
		<block type="logic_boolean"></block>
		<block type="logic_null"></block>
		<block type="logic_ternary"></block>
	</category>
	<category name="Math">
		<block type="math_number"></block>
		<block type="math_arithmetic"></block>
		<block type="math_single"></block>
		<block type="math_trig"></block>
		<block type="math_constant"></block>
		<block type="math_number_property"></block>
		<block type="math_change">
			<value name="DELTA">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
		</block>
		<block type="math_round"></block>
		<block type="math_on_list"></block>
		<block type="math_modulo"></block>
		<block type="math_constrain">
			<value name="LOW">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
			<value name="HIGH">
				<block type="math_number">
					<title name="NUM">100</title>
				</block>
			</value>
		</block>
		<block type="math_random_int">
			<value name="FROM">
				<block type="math_number">
					<title name="NUM">1</title>
				</block>
			</value>
			<value name="TO">
				<block type="math_number">
					<title name="NUM">100</title>
				</block>
			</value>
		</block>
		<block type="math_random_float"></block>
	</category>
	<category name="Lists">
		<block type="lists_create_empty"></block>
		<block type="lists_create_with"></block>
		<block type="lists_repeat">
			<value name="NUM">
				<block type="math_number">
					<title name="NUM">5</title>
				</block>
			</value>
		</block>
		<block type="lists_length"></block>
		<block type="lists_isEmpty"></block>
		<block type="lists_indexOf"></block>
		<block type="lists_getIndex"></block>
		<block type="lists_setIndex"></block>
	</category>
	<category name="Text">
		<block type="text"></block>
		<block type="text_length"></block>
    </category>
	<category name="Messages">
		<block type="message"></block>
    </category>
	<category name="Variables" custom="VARIABLE"></category>
	<category name="Functions" custom="PROCEDURE"></category>
	<category name="Library">
		<category name="Randomize">
			<block type="procedures_defnoreturn">
				<mutation>
					<arg name="list"></arg>
				</mutation>
				<title name="NAME">randomize</title>
				<statement name="STACK">
					<block type="controls_for" inline="true">
						<title name="VAR">x</title>
						<value name="FROM">
							<block type="math_number">
								<title name="NUM">1</title>
							</block>
						</value>
						<value name="TO">
							<block type="lists_length" inline="false">
								<value name="VALUE">
									<block type="variables_get">
										<title name="VAR">list</title>
									</block>
								</value>
							</block>
						</value>
						<value name="BY">
							<block type="math_number">
								<title name="NUM">1</title>
							</block>
						</value>
						<statement name="DO">
							<block type="variables_set" inline="false">
								<title name="VAR">y</title>
								<value name="VALUE">
									<block type="math_random_int" inline="true">
										<value name="FROM">
											<block type="math_number">
												<title name="NUM">1</title>
											</block>
										</value>
										<value name="TO">
											<block type="lists_length" inline="false">
												<value name="VALUE">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
											</block>
										</value>
									</block>
								</value>
								<next>
									<block type="variables_set" inline="false">
										<title name="VAR">temp</title>
										<value name="VALUE">
											<block type="lists_getIndex" inline="true">
												<mutation statement="false" at="true"></mutation>
												<title name="MODE">GET</title>
												<title name="WHERE">FROM_START</title>
												<value name="AT">
													<block type="variables_get">
														<title name="VAR">y</title>
													</block>
												</value>
												<value name="VALUE">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
											</block>
										</value>
										<next>
											<block type="lists_setIndex" inline="false">
												<value name="AT">
													<block type="variables_get">
														<title name="VAR">y</title>
													</block>
												</value>
												<value name="LIST">
													<block type="variables_get">
														<title name="VAR">list</title>
													</block>
												</value>
												<value name="TO">
													<block type="lists_getIndex" inline="true">
														<mutation statement="false" at="true"></mutation>
														<title name="MODE">GET</title>
														<title name="WHERE">FROM_START</title>
														<value name="AT">
															<block type="variables_get">
																<title name="VAR">x</title>
															</block>
														</value>
														<value name="VALUE">
															<block type="variables_get">
																<title name="VAR">list</title>
															</block>
														</value>
													</block>
												</value>
												<next>
													<block type="lists_setIndex" inline="false">
														<value name="AT">
															<block type="variables_get">
																<title name="VAR">x</title>
															</block>
														</value>
														<value name="LIST">
															<block type="variables_get">
																<title name="VAR">list</title>
															</block>
														</value>
														<value name="TO">
															<block type="variables_get">
																<title name="VAR">temp</title>
															</block>
														</value>
													</block>
												</next>
											</block>
										</next>
									</block>
								</next>
							</block>
						</statement>
					</block>
				</statement>
			</block>
		</category>
	</category>
</xml>


<script type="text/javascript">
	var socket = io.connect('http://192.168.0.103');

	Blockly.inject(document.getElementById('blockly'),
			{path: './', toolbox: document.getElementById('toolbox')});

	/**
	 * Bind an event to a function call.
	 * @param {!Element} element Element upon which to listen.
	 * @param {string} name Event name to listen to (e.g. 'mousedown').
	 * @param {!Function} func Function to call when event is triggered.
	 *     W3 browsers will call the function with the event object as a parameter,
	 *     MSIE will not.
	 */
	function bindEvent(element, name, func) {
		if (element.addEventListener) {  // W3C
			element.addEventListener(name, func, false);
		} else if (element.attachEvent) {  // IE
			element.attachEvent('on' + name, func);
		}
	}


	/**
	 * Backup code blocks to localStorage.
	 */
	function backup_blocks() {
		console.log('backup');
		if ('localStorage' in window) {
			var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
			window.localStorage.setItem('arduino', Blockly.Xml.domToText(xml));
		}

		var code = Blockly.Generator.workspaceToCode('JavaScript');
		socket.emit('code', code);
	}

	/**
	 * Restore code blocks from localStorage.
	 */
	function restore_blocks() {
		if ('localStorage' in window && window.localStorage.arduino) {
			var xml = Blockly.Xml.textToDom(window.localStorage.arduino);
			Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);

			var code = Blockly.Generator.workspaceToCode('JavaScript');
			console.log(code);

		}
	}

	function auto_save_and_restore_blocks() {
		// Restore saved blocks in a separate thread so that subsequent
		// initialization is not affected from a failed load.
		window.setTimeout(restore_blocks, 0);
		// Hook a save function onto unload.
		bindEvent(window, 'unload', backup_blocks);
	}

	auto_save_and_restore_blocks();

	var old;

	socket.on('position', function(position) {
		if (position && position.x && position.y) {
//    var code = Blockly.Generator.workspaceToCode('JavaScript');
//    socket.emit('code', code);

			if (!old)
				old = position;

			var c = document.getElementById("myCanvas");
			var ctx = c.getContext("2d");
			ctx.clearRect(old.x, old.y, 10, 10);
			ctx.beginPath();
			ctx.rect(position.x, position.y, 10, 10);
			ctx.fillStyle = 'rgba(46, 166, 203, 0.5)';
			ctx.fill();
			ctx.beginPath();
			ctx.moveTo(old.x, old.y);
			ctx.globalAlpha = 0.5;
			ctx.lineTo(position.x, position.y);
			ctx.strokeStyle = '#2ba6cb';
			ctx.stroke();

			old = position;
		}
	});


	socket.on('webcam', function(base64Image) {
		$('#cam').attr('src', base64Image);
	});
	socket.on('cv', function(base64Image) {
		$('#cv').attr('src', base64Image);
	});

</script>
</body>
</html>